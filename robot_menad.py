from robot import *
import math
import re

# NOTE TOURNOI:
# - pas de fichiers externes
# - pas d'env vars
# - 1 seule mémoire: self.memory (int)
# - tout le comportement est dans step (helpers internes)

class Robot_player(Robot):
    team_name = "MenadTeam-NN+BRAIT"
    # Mets ici tes infos si demandé par le sujet:
    # noms_prenoms = "Menad ACHERAIOU"
    # no_etudiant = "..."

    def __init__(self, x, y, theta, name="n/a", team="A"):
        super().__init__(x, y, theta, name=name, team=team)
        self.memory = 0
        m = re.search(r"menad_(\d+)", str(self.name))
        self.idx = int(m.group(1)) if m else (self.id - 1)

    def step(self, sensors, sensor_view=None, sensor_robot=None, sensor_team=None):
        # ----------------------------
        # Constantes capteurs
        # ----------------------------
        F, FL, L, RL, RE, RR, R, FR = 0, 1, 2, 3, 4, 5, 6, 7
        VIEW_NONE, VIEW_WALL, VIEW_ROBOT = 0, 1, 2

        # ----------------------------
        # Hyperparams NN
        # ----------------------------
        NUM_INPUTS = 34
        HIDDEN = 8
        NUM_OUTPUTS = 2  # t, r

        # ----------------------------
        # Génomes EMBED (best_genomes.json)
        # format: genomes[mode][idx] = list(params)
        # ----------------------------
        genomes = {
            "open": {
                "0": [0.22458149026042265, -0.7953802126371169, 1.2470627039963107, 0.5388851029023143, 1.0735470648628225, 0.039896137061665726, -0.03226016061076947, -0.054654284114955154, -0.4154877473377442, -0.686339350051467, 0.8917201432696479, 0.712545437798266, 1.097554151866188, -0.3072852646606929, 0.7331660356696517, 0.3067106871370912, -0.11918852418933293, -0.9764382518974736, -0.6651475803461985, -0.08740292741467282, -0.8291995531351596, 0.8830018748293574, 0.041156371025741906, -0.5056648638481552, 1.3071871860466493, 1.3236740126592756, 0.2976762671098168, -0.8129327387400036, 0.09130831079080526, -0.08207866893138024, 0.12044060477676712, 1.3781075766256203, -0.48918854968321346, 0.9821718703001878, 0.14979029126240534, -0.727187828010445, 0.9124072626256383, -0.01434966928056422, -0.06375542412743865, -0.4863241664047522, -0.4493058203581144, 0.5968232635664366, -0.2679243105944925, -0.21721628370643187, -0.0038008508674112207, -0.021186486419038836, 0.25210560344313493, 0.9256691442129787, 0.3827167725162106, 1.4725727329314053, -0.7206283971756229, 0.05412662097775747, -1.0112576555675803, 0.5271004376366932, 0.6274275044515794, -0.6183411814048598, 0.03995258329411653, 1.6953956081736297, 1.4716005726883215, 0.555887599698769, 0.43497057350780327, -0.8824191037000356, -0.7102135529584419, -0.10325763424780102, 1.4546604492687085, -0.6871206360257568, -0.5353072504339744, -1.00968262544168, -0.6991228599927826, 0.2491363257585947, -0.08720520221222275, -0.3364136944938395, -0.22455806507060455, 0.6980476044952207, -0.4985432703169606, 0.6554920051358631, -0.7136351979794933, 0.6938348910710915, 0.8518260157113918, 1.2175855965907825, 0.22686494446859345, 0.26000047442366075, -0.008584696421238602, 1.2356491873039752, -0.13651987038378155, 1.7503725513369432, 1.055161529054449, -0.10966956957320217, -0.5905176415366662, 0.4720017092074376, 0.8310889071776537, -0.6944970529018627, -0.0013032448646204953, 0.5151823536657352, 0.48248028596859655, -1.2053946287796666, 0.4612925648808912, 0.5941376627696078, -0.11849616808932877, 1.6775801847736849, -0.8237001893815447, 0.9431267156522404, -0.006257922067130495, -0.4737122298661865, 0.024111970816119876, 1.1167414741803936, -1.2708227967802215, 0.3771956435245226, -0.8805962747895266, 0.013413125729583954, 0.8188975175435977, 1.008881099036945, -1.3043857756893202, -1.3307154956481302, 1.0065125900947516, 0.4114357182429017, -0.847592328472009, 0.9056997477376394, 0.5014477451382278, -0.4213955517990765, -0.3541593820252271, 0.8408000438283957, 0.6405122676829267, -0.5369936819962209, 0.9470415809681985, 1.2375800910026964, 0.2737131046007307, -0.11292688954272331, 0.5275616943592931, -1.897633642698594, 1.0184307031135644, 1.5290745307268476, -0.31423415814437855, 0.26910659901882006, 0.1080763213103128, 0.38062740864619093, -0.1711301579830666, -0.4592747577016146, 1.1185425322048101, 0.6119334939016058, 0.06996633202911734, 0.24078330559826286, -0.16344932353137298, 0.5685417872686374, 0.16984742748993695, -0.005597734641823768, -0.17091030526006593, 0.3429513697979275, 0.40454247362913803, -0.78295480316155, 1.0625617052842011, -0.2716443700842702, 0.4440774393699911, -0.7265081343305586, 0.8681310302914531, -0.20895325077811952, 0.5154332977320665, -0.23898873715152735, 0.8228654144551836, 1.137404835314037, 0.03688259951194822, 1.2646594362850554, -0.42358035354990886, -1.7399516692102115, -0.6212737960535257, 0.04024420703830911, -0.13211946776335193, 0.18602643389923418, 0.4392081162862147, 1.0923128184064113, 0.6629080382323921, -0.9734405338375635, -0.9069636132016539, -0.5236614157419769, 0.6484114255892706, -0.5195819103989932, 0.9173655948528914, -0.056241605824226375, -0.5242723235322794, 1.319632013867662, -1.5455267100700438, 1.1451026522893593, -0.301959781664001, 1.1362401410107406, 0.23010506095739944, -0.5408302940421572, -0.28340250732918093, -0.12731941712932077, 0.6801967173616706, 0.3372596951964903, 1.3582091142735107, -1.284078528031974, -0.4963074922438678, 0.8870894824667187, 0.9555289500476488, 0.9434342425380176, -0.24916352981361972, -0.989531061594056, 0.3831146214114107, -0.5858133546186478, 0.5614389129719691, -0.020420010072540212, 0.1997631449624207, 0.9588415180969658, 0.5009228560220622, -0.2445941479088813, -0.06746336988701533, 0.09429933636015225, -0.03520898798933904, -0.18101694598565432, 0.05063620464237151, -0.9539005627876491, -0.36101513990236467, 0.39191236122888984, -0.223821193246067, -0.26426970132388894, 0.24944034610445728, -0.3011389726505531, -0.8096449729163063, -0.03657271675082411, -0.5637235384403327, 0.05523181528454103, 0.2673692500122473, 0.29424547455949557, -0.1062515527763922, -1.0334807642020603, -0.9248345271473032, -0.6801059234589077, 0.13278943811249339, -0.5343580874391431, 0.8221607125525359, 0.3165667437368901, 0.3938445951186922, 0.5612081165347176, -0.870515928209473, -0.36008074495980724, 0.4905174826028058, -0.4030810986142896, 1.1808317407954658, 0.26404238624263254, 0.09025231469982921, -0.429655247680687, 0.9309978890769366, 0.6362119811690404, -1.0072556253491403, 0.2993494698312139, 0.8586057064014264, -1.712532638126679, -1.0523703471782353, -0.4635410792297006, -0.20710059167975242, 0.14122871929092976, 1.2069521890518122, 1.1270184785772488, 0.42629300747627075, 0.3224853121560127, 1.0657463134462366, 0.6943448739532104, -1.1811804379928337, -0.06295716314608008, 1.535602968910468, -0.7515468305074449, 0.5173341346904566, 1.188180355100389, 0.3314008612890645, 0.02809146376951671, -0.688047051628471, 0.6025076976084452, 1.0883605104921237, -0.29862891497552946, -0.4412549434640285, 1.0160252842278523, 0.4906875587715236, 0.5128911778407361, 1.2546766501022402, -0.20884120430866523, -0.7744940806060673, 0.4340555901643121, 0.28525491073298115, 1.1676898080059215, 0.6689693350607111, 0.15614427751855417, 0.2629372343640808, 0.01214865561579001, -0.2614652574289824, 0.8372048462262167, 0.1649325080221417, 0.09948428115319138, 1.0362385713701583, -0.2578212542933847, 1.041086194182628, 0.9114967340273361, -0.15833589188653402, -1.3489513739529966, -0.6344423850378484, 0.252454104230984, 0.09556603359334195, 1.6287630233626267],
                "1": [1.1918114040196204, -0.08339979556591538, 0.9405058314353476, 0.2953235744572417, -0.3253449884131431, -0.42672653471105826, 2.0, -0.35859421819706766, -0.39463460787902993, -0.4318385911834803, -1.2025042374355461, -1.8130968795585543, 0.053383542364431595, -0.2974488924002866, -0.382213636288356, 0.008625683426367103, 0.5005834584252274, -1.0958336365009769, -0.015306474096961703, 0.1462341635343247, -1.197384955519204, 0.22517549984696736, -1.0957429092152307, 0.20319090311384477, -0.2568578594252582, -0.7322006471624602, 0.15267961045553113, 0.6313085475905789, -0.49732243837598844, 0.0024021432839600176, 0.07808748500906224, 0.36426995475930013, -1.1031138206904976, 0.5667791572104582, 0.447512950794278, -0.5158724793369488, -0.9758485453290546, -1.194982150341066, -0.9643681153498398, 0.3667519813149326, -0.9071757763656625, 1.326882536069715, -1.5645414833565128, -0.4731730505599878, -1.5978398707774653, -0.9183836146177935, 0.6884187642876898, -0.4686455182223366, -0.47005012035250354, 0.7625749112636763, 0.819890301866358, -0.7482668634126017, -0.6537487122315967, -0.29962777049602995, -0.4729319714244399, 0.47853370631525805, -0.5650098844159681, -0.1444402918615585, -0.8908825397789518, 0.0906163626131761, 0.5830690571661892, 0.1980521483336623, 1.0658626940370834, -0.7096750065375824, -1.1678222003053296, -0.7739005695275306, 0.5693787839461019, -0.7865882586822021, 0.4739044530413381, -0.28118535551157875, -0.3750285482749767, 0.00236409383583136, -1.6454887423694762, -0.4100638787227799, -0.17788806681541933, -0.2068268384968924, -0.8338926590742272, -0.923119284807135, -0.02928741489583972, 1.0809709459807841, -0.1291090960383389, -0.01903940557212993, -0.6165108429237647, -1.3411994206121485, 0.9855413125780504, 0.09613488379972905, 0.5384266758098799, 1.2667723156294048, -0.2052814910341171, -0.05493696439063146, 0.9442367492392114, -0.9024061581786644, -0.06843428763749806, 0.5434335371585103, 0.2106665122632778, -0.00733877259014451, 0.34158191354916595, 0.5707973248384584, -0.8090027474819872, -0.6247739713492169, -0.7107589535547387, 0.49753568336228476, -0.2911538010469477, -1.4515126778669223, 0.2883386371004867, -0.10359922898374829, 0.08510591577157933, -0.008062439797965226, -0.736119471288631, -0.858473251792103, -1.4886586648809883, 0.6601567227020543, -0.26231236911745565, -1.2843524027138993, -0.005594146500694314, 0.2773362577276246, 0.049306873611835236, -1.0931282301808496, 0.747918545161391, -0.4318481917072974, 0.6049173249768622, -0.08175542935471765, 0.8015302413376909, -0.4106248858788472, -0.3579364224150195, -1.0482230127216334, -0.4134955014933207, 0.20623678238260643, 0.3330847291476885, 0.2604752010925686, -0.471471744277391, 0.2286325768158018, 0.8967892343554251, 0.6799373842215093, 0.47342778801523, -0.3705645844979748, -0.8786889207866686, 0.25889023118188104, 0.02642101588142748, 0.4464756471984196, -0.6931463917166532, 0.35198606164971713, 0.6708046262527367, 0.02756177387695196, 0.3545699641003009, -0.9448781009685807, 0.06925562936773594, -0.47751636472343567, -0.8079742560293068, 1.2469130317971937, -0.4951504473364587, 0.022980551674893324, 0.4225246801628584, 0.5636321669774043, 1.245648131665438, 0.3991306503208795, 0.2163921537251758, -0.5355312350666148, 0.40623119716732303, 0.40204163257066916, -0.8989459899483405, -0.2485915214957129, 0.25693868920701307, -0.3593137676547315, -0.0501057577117591, 0.2986859167791721, -0.698036874514226, -0.5069042876949117, -0.17956489127623435, -0.147942620979056, -0.49600730775341134, 0.1857306286749399, 0.8675177150050374, 1.0876020381172131, -0.28121446675172457, 0.33959468814704397, 0.05239237084977444, -0.2520526291669711, 0.28442482959105375, 0.36380029614408277, 0.1722252268555089, 1.2834445269588282, 0.4026484095287657, -0.3633530002153989, -1.2847511795972382, -0.8324786183690698, 0.5402726692935697, 0.2531085577451444, -0.6193768262736373, 0.9973808574677524, -0.628052057489364, -0.6863754025704434, -1.225992502840528, -0.5843995202026616, 0.9074749659035954, -0.25157141655017856, -0.4168350705021747, -0.6684034910936631, -0.34557963933775615, 0.42794607446305627, 0.0019406606811065985, -0.18548312654415147, 0.2968047489741338, 1.2619925380571129, 0.6717982756482512, -0.42686147019203347, -0.1270921179339644, 0.2405648103700203, -0.8744810644924254, 0.41616322220468355, -0.8455870773876003, -0.3701404423721985, -0.8803388642787022, 0.5874656529353146, 1.6269754355540411, 0.24356765457058266, -0.6436912142962263, -0.9149239632598312, -0.807836732791315, -0.0717446234237242, 1.0880054411565077, -0.19823595221854307, -0.44832958858982475, 0.06243399540976747, 0.45187754798199103, 0.4384248449344782, -1.0015855195544714, 1.2073923120736656, -0.13305136435379367, 1.3546734660936879, -0.38457662676667476, 0.2948604847180806, 0.060567604625207896, 0.9233825317228759, 0.16957684159376268, -0.31884004550861317, 0.12780848020032895, -0.41546437386883756, 0.06402270081839775, 0.01970875834698807, -1.966741895343048, 0.9289254434902663, 0.7113128683568785, -0.7472609727527939, 0.06546752936141524, -1.1757837483532034, -0.770754953672142, 0.9649587531387029, 1.7528363070806117, 0.3522578709913808, 0.2690713235700554, -0.8282100941082934, 1.020129386312166, -1.4306560748309918, -1.2167710140988879, -0.6936931580926261, 0.08878298128270823, 0.5914869924632601, 0.03755906525216615, -0.3777623125715861, 1.7281430462484852, -0.8153454120923939, -0.12738788759128122, -0.7118772649717214, -0.7019046798919755, 0.6025313520090367, -0.3236954943090208, -1.50864818517358, 0.7871916625010045, -1.7176665721108897, -0.41000807849770016, -1.0598429433786622, 0.07430450774422585, 0.6143463830842637, 0.4667913324046926, 1.0001308302205647, -0.37774096696787723, 0.5045447581166901, 0.8652399997266017, -0.26252922569316184, 1.140974245202988, -0.4760468404516707, 0.8954279450692818, -0.5870171728110161, -1.3244130886655148, -0.26855561420155605, 0.23347070114598054, 0.23678239019336594, -0.4640058766956547, 1.0541650874893325, -1.0456974178202143, -0.15569657866036157, 0.7942945730136378, -0.910843856011337, -0.9864027341801592, 1.0441479226918706, -0.004888336637579177, -0.12287110223154095]
            },
            "maze": {
                "0": [0.286151409031802, -0.6358999398173388, -1.0352898915032227, -0.03414948248941059, -0.3419769902106046, -0.2235979859339931, -0.5451103065958159, 0.16041161444102486, -0.46941669367614, -0.7401673033784733, 0.9639629074023635, 0.5014171407160741, 0.2710842480769891, 0.256151262812272, 0.567970751661234, -1.0848421195146705, 0.341065242241971, -0.8029495031957208, -1.7951359113947114, -0.1827056183348392, 0.4134115600970159, -0.06525505898408734, -1.1631718968894813, -0.20572770336009152, 0.3737859949483174, 0.7496266174616127, -1.3825578734557629, 1.6974195927850337, 0.12464661697078741, 1.1452969025390807, -1.809381647810108, 0.10617737133642285, 0.4655035088658749, 0.5010879807872526, -0.4456733951175852, 0.09803604236870264, -1.1165430529811142, -0.3627308433699917, 0.17089847735319164, -1.5181503723696637, 0.20624276907814074, 0.1477557617488316, 0.1018844422930433, 0.348239951065418, 0.4282041729367959, -0.5007199785218782, 1.0172507063773484, 0.1643494543542258, 1.7209792826352495, 1.6102942234669937, -0.4265327564623164, 0.848984723006895, 0.35007696818941886, 0.11457817521390452, -0.9628036987669476, 0.6695054702475146, -0.12596096536982393, 0.923458901057598, 0.1755102819801759, 1.2055578253787402, -1.6478247338648784, 0.5257894681941457, 0.23554966006499123, -0.07936558762917588, 0.4427474429865703, -0.47671347222629173, 0.3828795731145714, 0.13631818159490727, 0.8477758508568912, -0.9385462472793381, -0.5882342637003803, 0.723838876905708, 0.7347140186038799, -1.5489151399051053, -0.8491946916902585, -1.4832070757995905, -1.153263865441235, 1.2864934376144697, -1.3899894114018914, 0.8295090363070016, -0.8527458424853578, 1.1177926058942833, -0.8739564208868646, -0.7685298879542806, 0.26538446765794543, 0.04364284947973755, -0.5574493652015571, -1.0487084366267656, -0.4560823390771114, -0.6346788573455262, -0.050793852390964865, 1.3229189594753588, -0.626273641640572, -0.14582093944215715, -1.396138010470127, -1.8723286669196668, -0.26732836059284515, -0.23095257612903045, 0.990577102343992, -1.1760313085527498, 0.38093907149303075, 0.788709054783571, -0.5367850381955788, -0.1986778647716051, 0.4371012557016407, 0.7068637278631205, 0.35800930258640806, -0.4991670139056494, -0.00014985042249445607, -0.1433402355161445, 1.5065075261987428, 0.21838293214045634, -0.17520562771254586, -0.6863047383214366, 0.07624441688683715, -0.14167751439564735, 0.9741160978047113, 1.3647999465845762, 0.5650902106094543, 1.6144115087859658, -0.23134705103587938, -0.6799593385163198, 1.6438788250737382, -0.06750663635572315, -0.479603635188443, 0.25228953465205284, -1.1703689684301863, 0.057433058903322246, -0.1870084117337643, 0.44787582336004683, -0.3701821966915648, -0.3700384079222475, 0.10607929080524107, -0.8794236714902937, -0.6755658431691046, 0.1562332662414581, -0.626804755260421, 0.4600169734452545, -0.5532739149221584, 0.6424648862940359, -0.938248532408585, 1.6276171086399427, 0.013430964930855067, -0.6750350635076093, -1.5183885883094563, -0.04897112865046597, -1.0651453896300989, 1.7712763834015506, 0.026409727571568273, 0.08343158228184189, 0.06543625004206749, -0.10688631452745961, -0.09546743246879907, -0.847001986545697, -1.3521690413309067, -1.041834102008524, -0.3599143024748964, -0.0951571707028141, 0.4561046909456344, 0.17565028596678844, -0.6001422772074688, 0.5863058336193541, -0.8016758246997268, -0.1910890542833798, 0.3447171444763168, -0.2668900470943374, 0.7787844794035628, -0.1296837500986023, -1.0868509921626026, -0.8582217248268169, 1.2192823404310695, 0.1220446076560038, 1.2470335182939862, -0.11247103659758359, 1.398636509822576, -0.8223827925502498, -0.5057473453112877, -2.0, 1.4070195632418163, 1.52193528138019, -0.8488618922172887, -1.8990930295568567, -0.07635637156612239, -0.2862205703222797, 0.5601780358600023, -0.1099749538224607, 0.9529125833096165, -0.9847344434090972, -0.191516546643698, 0.041248009363133435, 0.583117283553085, -0.6442884358042151, -0.2328404620780467, -0.08183531906434034, 0.07695521189887874, 0.4441855430996582, 0.5304089202620491, -0.22064936986034434, 0.6328565515649591, -0.086401919778204, 0.44916834374781156, 0.2132267450806946, -1.9231238212452648, -0.4719301311983726, 0.08362614929778518, 0.8966858490465519, 0.6331233030680494, -0.699910786427463, -0.6893640701843455, -0.4250133952517266, -0.2743829428778949, -1.1757212763555938, 0.8748454408249527, -0.4124116054025968, -1.3383467117448689, -0.1488616990748457, -0.8816793536424754, -0.4631388960345451, -0.2713313895133229, -0.3260712604655809, 0.5251513162523208, -1.1028508382587034, 0.8579167229490903, -0.7490842990430507, -0.696702739527799, -0.26107898976739424, -0.7850552532635358, 0.6807684369323344, -0.882646623648071, 0.3605478791575123, 0.7793534790337602, 0.033301032691472124, -0.25874692876018324, 0.861391034207825, 0.47705934194195654, 1.3093762306666894, -1.3216467539243715, 0.43086645335228135, 0.7477551567273699, -0.749047388500624, 1.204427973169903, 0.5134099652004901, -0.1855678454897892, 0.13308427700926545, 0.647969697293248, -1.672793929596418, -0.05405228194048744, -0.37909036608590413, 1.5649967707155494, 0.144138341421916, 0.9076609185760457, 0.4448082517268323, -0.0370509545972736, 0.013247503467973487, -1.1732566002573992, 1.314863745554782, -0.1210151773420903, 0.336382386872748, -1.321926856555358, 0.002654659552206961, -1.542714625024077, -1.2197856178704163, -0.261677899959535, 0.5118190458724947, 1.8287855012459182, -0.6555849195010338, 0.6821174378565596, -0.9203088232749466, -0.1655510564980647, -1.4900783506347133, 0.625929894096124, -1.1378150707188008, 1.068318073110863, 0.3314723569007249, 0.4591585991858841, 1.282173031069311, 0.40158165762938247, -1.9202198011325324, -0.4060088093197204, 0.28525178038431787, -1.0366026004406907, 1.4157196051008056, -0.9017661296652928, 1.4471614757172135, -0.2147412042591259, 1.2760118636548117, -0.1284029164185676, -1.2560968827774566, 0.9922473462822659, -0.7591572663916595, 1.206872078040512, 1.7151768740678166, -1.0013793643788058, -0.06812228338939354, -0.9479067866901776, -0.7833858239026417, -0.6486897669452255, 0.3975711371896073],
                "1": [-0.5448631620934905, 0.6745446496172962, 0.0049331092883662594, -1.018450672940926, -0.6002247206160327, 1.168909951374016, 0.8311603376301895, -0.6755788107791467, -0.810995538389971, 1.0751617979854386, 0.31428031901358955, -0.16395112496326078, -0.6887918048060304, -0.8711610916092476, -0.09829580320108651, -0.9468335901196213, -1.0026727406976959, -0.5145842149461158, -0.7560650124390061, -0.10852041647638541, -0.9290309705856523, -0.653230757244089, 0.7749947379719193, 0.26461866973794596, -0.6620773640578775, -0.17349402037620365, 0.11279306420043621, -0.24670130071063998, 1.4076263110455853, -0.5178116935451683, 0.38664234411347287, -0.7128439788072818, 0.5540547562926689, 0.3840014382247804, 0.4593689045128361, 0.5758272833360888, 0.03539860621786575, 0.3699210196862568, 1.2979157779184172, 0.4515394904966996, 1.5671347340819977, 0.46118916399153875, -0.9268357080396219, 1.270338878163097, 0.556790871848108, -1.2815077263678654, 0.04253094080005292, 0.6123687381428073, 0.4297709184520162, -0.528478585459742, 1.1263763547758168, -1.078661644780564, -0.44894409237245325, 0.109642349197205, -0.7052519741916191, -0.8572906216059024, -1.1649125101374278, 0.5966947175597982, 0.4847864549330972, -0.9457015005624484, -1.4011840277671348, -1.112344563758965, -0.5023558267383091, 0.10405328647517038, 0.9595960145093567, 1.721646671975169, 0.5644353603447642, -0.35809293477248205, -0.07137106795709114, 0.6122520014236322, -0.01427687495371291, 0.9889394592605086, 1.214228323406662, 0.37044713371051613, -0.6017178150478596, 0.020672536081257825, -1.4554200939828954, 0.18080114119335555, -0.014120160577765682, -1.2212342427100733, -0.7457146672502778, 0.7571622266575212, -1.7876182441769704, -0.09252205414041188, 0.43707759463779183, 1.1369772392067203, 0.45595088125389366, 1.141773627686955, 0.21440049306349515, -0.43521132650139144, 1.0147986811114944, 0.14724993747420048, 0.9007192131630466, 0.3283643471296631, -0.5474991879174926, 1.6403313837447973, 0.5053684280175629, 0.17010519526411383, -0.7140578762528673, 0.6139834461461567, -0.44731245409599835, 0.04928123092286714, -0.7336963041319613, 0.48457781054673577, -0.0022350436952802352, 0.3271719431146211, 0.7573560586033713, 0.033202959965038394, -0.4065986985747684, 1.5720897772023548, 0.6736128074927582, -0.6856378038032254, 0.9151222129215985, 0.36755534744178, 0.83172371967294, 0.5210648370121268, 0.5703368019463897, 0.6208900702973568, 0.3563467034438821, -0.5767397200957971, -1.3187379605019927, 0.4194023801531196, -0.35764643910791044, -0.5159352585446788, -0.8150919344912584, -0.7664507787963265, -1.1893555213107607, -1.1926850863977763, -0.2693773489894232, 0.2315029988550297, -1.4409499123812124, -0.17468616506734735, -0.9088161298941826, 0.89230157149275, 0.599215043711568, 0.18303285563551278, -0.7847317125112837, -0.1820160558139312, -0.007755914262299525, -1.0303246159587782, 0.6401850412827635, 0.6387539479016475, -0.13861761491453917, -0.6784806438818815, 0.11673613091696161, 0.27034731648182525, 0.6200354570707057, -1.1306826697066636, 0.9467464153460223, 0.6323792865493851, 1.2127395433129227, -1.301031624360505, -0.2574660137263849, -0.36007078835609807, -1.2978538153900347, 0.6148189382457429, -0.4632431357236794, 0.5080862719574686, -0.4405185984388277, 0.16182278098021435, 1.1951908211509097, -0.30478133951108916, 0.8808044825753201, 0.4432557844954578, 0.35371713094285473, 0.6161301386374662, 0.6044678999421547, -1.20370196015405, 0.6408471583221556, -0.6337456897130558, 0.18086563544651502, -0.5495520222501697, 1.0668239313005883, 1.2380406761294784, 0.9518639627312969, 0.3200632770337823, 0.5755831852023608, 0.9264645946751658, -0.08813684824558574, 0.6908505688934016, 0.1732435692869504, 2.0, -0.15046926440187758, -0.34247862691980213, -0.047145966713433886, 0.09915402824217501, -1.283529779400852, 0.13792769474008199, -0.8424740134825649, -2.0, 0.1798391353822758, 1.514806675648057, 1.098314784415049, 1.3116505328582952, 0.7358384158866952, -1.1028345087215083, -1.2428933399852466, -0.8083676337363359, 0.860472887249807, 0.7429617444153311, 0.25306739181572824, -0.2846282336625862, 0.45010190080382595, 1.4704386749316454, -0.15200031670552885, 0.6691102533224854, -1.4129612863476446, 0.0014163077439014527, 0.45301890473304496, -0.6686423844618745, 0.6435384144086329, 1.9079263682740546, 0.6547932907450728, -1.18766481052436, -0.8418693208656511, -0.1055733252249425, 0.9144338694962988, -0.8350469286688345, 0.8979835560955047, 0.5640954608639186, -0.7817505382383647, 0.7851869453653394, -0.85766032594237, -0.44731454431826284, 0.20545819438885757, -0.4459295993366123, -0.23794132024430253, -0.6675588215589895, 0.6928009222035455, -0.19328807290338695, -0.12633429889131859, 1.8677021592703014, -0.4481248106568444, -0.4470012521874728, -0.4737477810844025, -0.5616151344269043, -0.3233111766489044, -0.865471830819366, 0.6217752841393906, 0.5238735052473765, 0.07937644300392016, -0.42252492069937697, -0.2721722879495898, -0.6497275078348362, 0.4497790428294314, 0.46793099128017795, 1.079576452616085, 0.23342431775377404, 0.0034462533026645564, 0.4208030949703824, -0.11695129170444768, 1.4596834133441727, -1.6458709357826802, 0.47707981059140814, 0.5819846251637498, -0.6755818690005595, 0.2206330228529378, 1.1560229614517827, -1.6559584273478773, 0.6548810088717526, 0.02328079497389271, 1.061548358522373, -1.6100885281249822, -0.6779017154919101, -0.9949683841734044, -0.1536438843995862, -0.6560573732055879, 1.3113886870506002, 0.14482774964302728, 1.0368386546471884, 0.1145188016293025, 0.08410612089240664, -0.6552897535409752, -0.35843707950795495, -0.09389829829004559, -0.7672027088044722, 0.570859639040851, -1.4148715001949264, 0.3997912068644265, -0.37709237977140875, 0.033471510571698, 0.3810044524381476, -0.4282520626550022, 0.4991897137324428, 0.4758011878770512, 0.5409385049419347, -0.3409657523174666, 0.86569778814113, 1.013119580515025, 0.180186181909892, -0.5970624737075785, 1.0688994367443903, -0.02179780737371692, 0.3810757682803542, -0.9916055463130955, 0.39681335478888397, -1.0909207334356463, 0.21567485591145602]
            }
        }

        # ----------------------------
        # Helpers internes
        # ----------------------------
        def clamp(x, a=-1.0, b=1.0):
            return max(a, min(b, float(x)))

        def is_ally(i):
            return sensor_view[i] == VIEW_ROBOT and sensor_team[i] == self.team

        def is_enemy(i):
            return sensor_view[i] == VIEW_ROBOT and sensor_team[i] != self.team and sensor_team[i] != "n/a"

        # memory:
        # mem = mode*1_000_000 + ctx*10_000 + esc_dir*100 + esc_timer
        def mem_unpack(mem):
            mem = int(mem) if mem is not None else 0
            mode = mem // 1_000_000
            ctx = (mem // 10_000) % 100
            esc_dir = (mem // 100) % 100
            esc_timer = mem % 100
            mode = 0 if mode <= 0 else 1
            ctx = max(0, min(99, ctx))
            esc_dir = 1 if esc_dir else 0
            esc_timer = max(0, min(99, esc_timer))
            return mode, ctx, esc_dir, esc_timer

        def mem_pack(mode, ctx, esc_dir, esc_timer):
            mode = 0 if mode <= 0 else 1
            ctx = max(0, min(99, int(ctx)))
            esc_dir = 1 if esc_dir else 0
            esc_timer = max(0, min(99, int(esc_timer)))
            return mode * 1_000_000 + ctx * 10_000 + esc_dir * 100 + esc_timer

        def count_close_walls(thr=0.26):
            c = 0
            for i in range(8):
                if sensor_view[i] == VIEW_WALL and float(sensors[i]) < thr:
                    c += 1
            return c

        def detect_corridor():
            left_close = (sensor_view[L] == VIEW_WALL and sensors[L] < 0.35) or (sensor_view[FL] == VIEW_WALL and sensors[FL] < 0.30)
            right_close = (sensor_view[R] == VIEW_WALL and sensors[R] < 0.35) or (sensor_view[FR] == VIEW_WALL and sensors[FR] < 0.30)
            return left_close and right_close

        # NN forward 34->8->2, relu puis tanh
        def nn_forward(genome, x):
            total_params = (NUM_INPUTS * HIDDEN + HIDDEN) + (HIDDEN * NUM_OUTPUTS + NUM_OUTPUTS)
            g = genome
            if len(g) < total_params:
                # pad safety
                g = g + [0.0] * (total_params - len(g))
            elif len(g) > total_params:
                g = g[:total_params]

            idxp = 0
            W1 = []
            for _ in range(HIDDEN):
                W1.append(g[idxp:idxp + NUM_INPUTS])
                idxp += NUM_INPUTS
            b1 = g[idxp:idxp + HIDDEN]
            idxp += HIDDEN
            W2 = []
            for _ in range(NUM_OUTPUTS):
                W2.append(g[idxp:idxp + HIDDEN])
                idxp += HIDDEN
            b2 = g[idxp:idxp + NUM_OUTPUTS]

            h = []
            for j in range(HIDDEN):
                s = b1[j]
                w = W1[j]
                for i in range(NUM_INPUTS):
                    s += w[i] * x[i]
                h.append(s if s > 0 else 0.0)

            out = []
            for k in range(NUM_OUTPUTS):
                s = b2[k]
                w = W2[k]
                for j in range(HIDDEN):
                    s += w[j] * h[j]
                out.append(math.tanh(s))
            return out

        def nn_inputs34(ctx_norm, role):
            x = []
            # 8 distances
            for i in range(8):
                x.append(min(1.0, float(sensors[i])))
            # 8 walls
            for i in range(8):
                x.append(1.0 if sensor_view[i] == VIEW_WALL else 0.0)
            # 8 allies
            for i in range(8):
                x.append(1.0 if is_ally(i) else 0.0)
            # 8 enemies
            for i in range(8):
                x.append(1.0 if is_enemy(i) else 0.0)
            # ctx + role
            x.append(float(ctx_norm))
            x.append(float(role))
            return x

        # escape anti-blocage coins / alliés
        def do_escape_if_needed(esc_dir, esc_timer):
            if esc_timer > 0:
                esc_timer -= 1
                rot = +0.85 if esc_dir == 0 else -0.85
                return True, (-0.55, rot), esc_dir, esc_timer

            wall_hard = (sensor_view[F] == VIEW_WALL and sensors[F] < 0.14) or \
                        (sensor_view[FL] == VIEW_WALL and sensors[FL] < 0.12) or \
                        (sensor_view[FR] == VIEW_WALL and sensors[FR] < 0.12)

            ally_hard = (is_ally(F) and sensors[F] < 0.18) or \
                        (is_ally(FL) and sensors[FL] < 0.16) or \
                        (is_ally(FR) and sensors[FR] < 0.16)

            if wall_hard or ally_hard:
                esc_dir = 0 if (self.idx % 2 == 0) else 1
                esc_timer = 10 if self.idx == 2 else 14
                rot = +0.85 if esc_dir == 0 else -0.85
                return True, (-0.55, rot), esc_dir, esc_timer

            return False, (0.0, 0.0), esc_dir, esc_timer

        # wall follower (gauche) robuste + anti-corner soft
        def wall_follow_left():
            # règle: si mur devant proche => tourne à droite en avançant (évite coin)
            if sensor_view[F] == VIEW_WALL and sensors[F] < 0.55:
                return 0.80, -0.22

            left_seen = (sensor_view[L] == VIEW_WALL) or (sensor_view[FL] == VIEW_WALL) or (sensor_view[RL] == VIEW_WALL)

            if left_seen:
                if sensor_view[L] == VIEW_WALL:
                    d = sensors[L]
                elif sensor_view[FL] == VIEW_WALL:
                    d = sensors[FL]
                else:
                    d = sensors[RL]

                target = 0.28
                err = target - d

                # correction douce (évite spirale)
                r = clamp(0.75 * err, -0.22, 0.22)
                t = 0.88

                # si trop proche du mur => s'écarte un peu plus
                if d < 0.16:
                    r = -0.22
                    t = 0.82

                return t, r

            # si aucun mur à gauche: arc très léger à gauche pour "capturer" un mur, sans tourner en rond
            return 0.90, +0.10

        # hunter (comme ton "bon" comportement)
        def hunter():
            STEER = {F: 0.0, FL: +0.6, L: +0.9, RL: +1.0, RE: 0.0, RR: -1.0, R: -0.9, FR: -0.6}

            # anti-corner
            front_wall = (sensor_view[F] == VIEW_WALL and sensors[F] < 0.55)
            fl_wall = (sensor_view[FL] == VIEW_WALL and sensors[FL] < 0.35)
            fr_wall = (sensor_view[FR] == VIEW_WALL and sensors[FR] < 0.35)
            if front_wall and (fl_wall or fr_wall):
                if fl_wall and not fr_wall:
                    return -0.35, -0.35
                if fr_wall and not fl_wall:
                    return -0.35, +0.35
                return -0.35, (+0.35 if (self.idx % 2 == 0) else -0.35)

            # anti-wall early à haute vitesse
            if sensor_view[F] == VIEW_WALL and sensors[F] < 0.75:
                left_free = sensors[FL] if sensor_view[FL] != VIEW_WALL else 0.0
                right_free = sensors[FR] if sensor_view[FR] != VIEW_WALL else 0.0
                t = 0.85
                r = -0.18 if right_free > left_free else +0.18
                return t, r

            # chase
            best_i, best_d = None, 1.0
            for i in range(8):
                if is_enemy(i) and sensors[i] < best_d:
                    best_d, best_i = sensors[i], i

            if best_i is not None:
                r = STEER.get(best_i, 0.0)
                if best_d > 0.45:
                    t = 0.95
                elif best_d > 0.25:
                    t = 0.75
                else:
                    t = 0.50
                return clamp(t), clamp(r)

            # explore rapide
            t = 1.00
            r = +0.08 if (self.idx % 2 == 0) else -0.08

            if sensor_view[L] == VIEW_WALL and sensors[L] < 0.28:
                r = -0.16
            elif sensor_view[R] == VIEW_WALL and sensors[R] < 0.28:
                r = +0.16

            if sensor_view[FL] == VIEW_WALL and sensors[FL] < 0.35:
                r = -0.16
            if sensor_view[FR] == VIEW_WALL and sensors[FR] < 0.35:
                r = +0.16

            if (sensor_view[L] == VIEW_WALL and sensors[L] < 0.22) and (sensor_view[R] == VIEW_WALL and sensors[R] < 0.22):
                t = 0.85

            return clamp(t), clamp(r)

        # update mode/ctx: augmente si “tape” / couloir / beaucoup de murs proches
        def update_mode_ctx(mode, ctx):
            many = (count_close_walls(thr=0.26) >= 3)
            corridor = detect_corridor()
            front_hit = (sensor_view[F] == VIEW_WALL and sensors[F] < 0.14)

            if front_hit:
                ctx = min(99, ctx + 7)
            elif many or corridor:
                ctx = min(99, ctx + 2)
            else:
                ctx = max(0, ctx - 1)

            # hysteresis anti-flip
            if mode == 0 and ctx >= 60:
                mode = 1
            elif mode == 1 and ctx <= 40:
                mode = 0
            return mode, ctx

        # ----------------------------
        # Sécurité équipe
        # ----------------------------
        if self.team != "A":
            return 0.0, 0.0, False

        # ----------------------------
        # Lecture mémoire + mode auto
        # ----------------------------
        mode, ctx, esc_dir, esc_timer = mem_unpack(self.memory)
        mode, ctx = update_mode_ctx(mode, ctx)
        ctx_norm = ctx / 99.0

        # ----------------------------
        # Escape global (anti-blocage)
        # ----------------------------
        esc, (t, r), esc_dir, esc_timer = do_escape_if_needed(esc_dir, esc_timer)
        if esc:
            self.memory = mem_pack(mode, ctx, esc_dir, esc_timer)
            return t, r, False

        # ----------------------------
        # Robots spécialisés Braitenberg
        # ----------------------------
        if self.idx == 2:
            t, r = wall_follow_left()
            self.memory = mem_pack(mode, ctx, esc_dir, esc_timer)
            return clamp(t), clamp(r), False

        if self.idx == 3:
            t, r = hunter()
            self.memory = mem_pack(mode, ctx, esc_dir, esc_timer)
            return clamp(t), clamp(r), False

        # ----------------------------
        # NN robots (idx 0 et 1)
        # ----------------------------
        if self.idx in (0, 1):
            role = 1.0 if self.idx == 1 else 0.0
            x = nn_inputs34(ctx_norm, role)

            key_mode = "maze" if mode == 1 else "open"
            g = genomes[key_mode][str(self.idx)]
            out = nn_forward(g, x)

            t_raw, r_raw = out[0], out[1]

            # translation: [0..1] + minimum pour éviter l’arrêt
            t = (t_raw + 1.0) * 0.5
            t = max(0.15, min(1.0, t))

            # rotation: limiter pour éviter spin
            r = clamp(r_raw, -0.35, 0.35)

            self.memory = mem_pack(mode, ctx, esc_dir, esc_timer)
            return clamp(t), clamp(r), False

        # fallback
        self.memory = mem_pack(mode, ctx, esc_dir, esc_timer)
        return 0.55, 0.0, False
